# å¾®ä¿¡å…¬ä¼—å·åˆ†äº«åŠŸèƒ½å¼€å‘

å¿…éœ€å‚æ•°

```
appId: '', // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
timestamp: , // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
nonceStr: '', // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
signature: '',// å¿…å¡«ï¼Œç­¾å
jsApiList: [] // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨
```

## 1.é€šè¿‡appid+secretè·å–`access_token`

```
httpsè¯·æ±‚æ–¹å¼: GET
https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
```

**å‚æ•°è¯´æ˜**

| å‚æ•°       | æ˜¯å¦å¿…é¡» | è¯´æ˜                                  |
| ---------- | -------- | ------------------------------------- |
| grant_type | æ˜¯       | è·å–access_tokenå¡«å†™client_credential |
| appid      | æ˜¯       | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯                    |
| secret     | æ˜¯       | ç¬¬ä¸‰æ–¹ç”¨æˆ·å”¯ä¸€å‡­è¯å¯†é’¥ï¼Œå³appsecret   |

**è¿”å›è¯´æ˜**

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¾®ä¿¡ä¼šè¿”å›ä¸‹è¿°JSONæ•°æ®åŒ…ç»™å…¬ä¼—å·ï¼š

```json
{"access_token":"ACCESS_TOKEN","expires_in":7200}
```



## 2.é€šè¿‡`access_token`è·å–`jsapi_ticket`

```
httpsè¯·æ±‚æ–¹å¼: GET
https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=ACCESS_TOKEN&type=jsapi
```

**è¿”å›è¯´æ˜**

```json
{
    "errcode":0,
    "errmsg":"ok",
    "ticket":"bxLdikRXVbTPdHSM05e5u5sUoXNKd8-41ZO3MhKoyN5OfkWITDGgnr2fwJ0m9E8NYzWKVZvdVtaUgWvsdshFKA",
    "expires_in":7200
}
```

## 3.ç”Ÿæˆç­¾å



## é™„å½•ä¸€ï¼šè·å–access_token

```python
# ä¸€èˆ¬access_tokenæœ‰æ•ˆæœŸä¸º7200s,é¿å…é‡å¤è¯·æ±‚ï¼Œä½¿ç”¨redisä½œä¸ºç¼“å­˜
class WxShare(Resource):
    def __init__(self):
        if redis.get("access_token"):
            self.access_token = eval(str(r.get("access_token"), "utf8"))
        else:
            self.access_token = {
                "access_token": "",
                "update_time": time.time(),
                "expires_in": 7200
            }


        def get_access_token(self):
        # éªŒè¯tokenæ˜¯å¦è¿‡æœŸï¼Œæ˜¯ï¼šé‡æ–°è¯·æ±‚ï¼Œå¦ï¼šç›´æ¥è¿”å›
        if not self.access_token.get("access_token") or (time.time() - self.access_token.get('update_time')) > self.access_token.get('expire_in'):
            resp = requests.get(
                "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s" % (appID, appSecrete))
            rp = resp.json()

            if 'errcode' in rp:
                raise Exception(rp.get("errmsg"))
            else:
                access_token = {
                    "access_token": rp["access_token"],
                    "expire_in": rp["expires_in"],
                    "update_time": time.time()
                }
                self.access_token = access_token
                r.set("access_token", access_token)
                return rp["access_token"]
        else:
            return self.access_token.get('access_token')
```

## é™„å½•äºŒï¼šç”Ÿæˆéšæœºæ•°

```python
# è·å–noncestrï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰
def createNonceStr():
    import random
    chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    str = ""
    for i in range(0, 16):
        s = random.randint(0, len(chars)-1)
        str += chars[s:s+1]
    return str
timestemp = int(time.time)
```

```
access_token = {"access_token":rp["access_token"],"expires_in":rp["expires_in"],"update_time": time.time()}
```


## é™„å½•ä¸‰:ç”Ÿæˆç­¾å

```python
    def post(self):
        import hashlib
        url = request.json["url"]
        timestamp = int(time.time())
        js_ticket = self.get_jsapi_ticket()

        # æŠ¥é”™ä¿¡æ¯
        if type(js_ticket) == dict:
            return js_ticket

        nonce = createNonceStr()
        ret = {
            "noncestr": nonce,
            "jsapi_ticket": js_ticket,
            "timestamp": timestamp,
            "url": url
        }
        temp = "&".join(['%s=%s' % (key.lower(), ret[key]) for key in sorted(ret)])
        # 2. å°†ä¸‰ä¸ªå‚æ•°å­—ç¬¦ä¸²æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œsha1åŠ å¯†
        # sigæ˜¯è®¡ç®—å‡ºæ¥çš„ç­¾åç»“æœ
        sig = hashlib.sha1(temp.encode("utf8")).hexdigest()
        package = {
            "timestamp": timestamp,
            "noncestr": nonce,
            "signature": sig
        }
        
        return trueReturn(package)
```
**éªŒè¯ç”Ÿæˆçš„sigæ˜¯å¦æœ‰æ•ˆ**

<a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign">ğŸ‘‡æˆ‘</a>

<center><img src="http://qiniu.s001.xin/xtkqm.jpg" width=500></center>
